package:
  name: permissions-test
  version: 1.0.0
  epoch: 0
  description: Test file permissions and chmod
  copyright:
    - license: MIT

pipeline:
  - name: setup
    runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      mkdir -p ${{targets.destdir}}/usr/lib
      mkdir -p ${{targets.destdir}}/etc

  - name: create-executable
    runs: |
      cat > ${{targets.destdir}}/usr/bin/myapp << 'SCRIPT'
      #!/bin/sh
      echo "Hello from myapp"
      SCRIPT
      chmod 755 ${{targets.destdir}}/usr/bin/myapp

  - name: create-library
    runs: |
      echo "library content" > ${{targets.destdir}}/usr/lib/libtest.so.1.0.0
      chmod 644 ${{targets.destdir}}/usr/lib/libtest.so.1.0.0
      ln -s libtest.so.1.0.0 ${{targets.destdir}}/usr/lib/libtest.so.1
      ln -s libtest.so.1 ${{targets.destdir}}/usr/lib/libtest.so

  - name: create-config
    runs: |
      echo "config=value" > ${{targets.destdir}}/etc/myapp.conf
      chmod 600 ${{targets.destdir}}/etc/myapp.conf

  - name: verify-permissions
    runs: |
      # Verify executable
      test -x ${{targets.destdir}}/usr/bin/myapp || exit 1

      # Verify symlinks exist
      test -L ${{targets.destdir}}/usr/lib/libtest.so || exit 1
      test -L ${{targets.destdir}}/usr/lib/libtest.so.1 || exit 1

      # Record results
      ls -la ${{targets.destdir}}/usr/bin/myapp > ${{targets.destdir}}/etc/perms.txt
      echo "permissions verified" >> ${{targets.destdir}}/etc/perms.txt
