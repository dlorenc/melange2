package:
  name: test-pipeline-test
  version: 1.0.0
  epoch: 0
  description: Test post-build test pipeline execution
  copyright:
    - license: MIT

pipeline:
  - name: install-binary
    runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      mkdir -p ${{targets.destdir}}/etc

      # Create a simple script that can be tested
      cat > ${{targets.destdir}}/usr/bin/testable <<'EOF'
      #!/bin/sh
      case "$1" in
        --version)
          echo "testable 1.0.0"
          ;;
        --help)
          echo "Usage: testable [--version|--help]"
          ;;
        *)
          echo "Hello from testable"
          ;;
      esac
      EOF
      chmod +x ${{targets.destdir}}/usr/bin/testable

      # Create config file
      echo "enabled=true" > ${{targets.destdir}}/etc/testable.conf

test:
  pipeline:
    - name: verify-version
      runs: |
        # Test version output
        output=$(testable --version)
        echo "Version output: $output"
        if [ "$output" != "testable 1.0.0" ]; then
          echo "Version check failed"
          exit 1
        fi

    - name: verify-help
      runs: |
        # Test help output
        testable --help | grep -q "Usage:"
        if [ $? -ne 0 ]; then
          echo "Help check failed"
          exit 1
        fi

    - name: verify-config
      runs: |
        # Test config file exists
        if [ ! -f /etc/testable.conf ]; then
          echo "Config file missing"
          exit 1
        fi
        grep -q "enabled=true" /etc/testable.conf
